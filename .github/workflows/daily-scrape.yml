name: Event Scraping

on:
  schedule:
    # Daily: Ticketmaster API updates at 3:00 AM Melbourne time (5:00 PM UTC previous day)
    - cron: "0 17 * * *"

    # Weekly: Full scrape on Mondays at 2:00 AM Melbourne time (4:00 PM UTC Sunday)
    - cron: "0 16 * * 0"

  workflow_dispatch:
    inputs:
      scrape_type:
        description: "Type of scrape to run"
        required: true
        default: "daily"
        type: choice
        options:
          - daily
          - weekly

jobs:
  daily-scrape:
    name: Daily Ticketmaster Update
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      (github.event.schedule == '0 17 * * *') ||
      (github.event_name == 'workflow_dispatch' && inputs.scrape_type == 'daily')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Ticketmaster scraper
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          TICKETMASTER_API_KEY: ${{ secrets.TICKETMASTER_API_KEY }}
          CI: true
        run: npm run scrape:ticketmaster

      - name: Update popularity scores
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          CI: true
        run: npm run update-popularity

      - name: Report completion
        if: always()
        run: |
          echo "Daily scrape completed at $(date -u)"
          echo "Ticketmaster events updated successfully"

  weekly-scrape:
    name: Weekly Full Scrape
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      (github.event.schedule == '0 16 * * 0') ||
      (github.event_name == 'workflow_dispatch' && inputs.scrape_type == 'weekly')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Chromium system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon0 \
            libgbm1 \
            libasound2t64

      - name: Run comprehensive scraper
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          TICKETMASTER_API_KEY: ${{ secrets.TICKETMASTER_API_KEY }}
          CI: true
        run: npm run scrape

      - name: Update popularity scores
        env:
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          CI: true
        run: npm run update-popularity

      - name: Report completion
        if: always()
        run: |
          echo "Weekly scrape completed at $(date -u)"
          echo "All sources processed successfully"
